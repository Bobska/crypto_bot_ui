{% extends "base.html" %}
{% load static %}

<!--
    Working features to PRESERVE (do not alter logic; layout/styling changes only):
    - WebSocket connection and keepalive (terminal-init.js / websocket.js) with auto-reconnect and status indicator
    - TradingChart initialization and updates (trading-chart.js) including candlestick series and timeframes
    - Price update handlers (terminal-init.js): portfolio totals, quick-trade estimates, header price/change
    - Trade history display (terminal-init.js loadOrderHistory -> populates #orderHistoryBody)
    - Bot status indicators (emoji 🟡/🟢/🔴 in template + status text/buttons)
    - Tooltip implementation on chart (trading-chart.js subscribeCrosshairMove using seriesPrices)
-->

<!--
    📝 IMPORTANT NOTES FOR COPILOT — DO NOT BREAK THESE
    Keep all existing WebSocket connection code
    Keep all existing TradingChart initialization
    Keep all existing chart update logic
    Keep all existing tooltip code
    Keep all existing trade marker logic

    ONLY CHANGE:
    - HTML layout structure (3-column grid)
    - Card designs and styling
    - How data is displayed (not how it's received)
    - CSS styling and animations

    STRATEGY:
    - Move existing working code into new layout structure.
    - Don't rewrite working features — just reorganize and restyle them.
-->

{% block title %}Trading Terminal - Crypto Bot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/trading-terminal.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Terminal Header (preserved) -->
    <div class="terminal-header">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <span class="symbol-badge">
                    <i class="fab fa-bitcoin"></i> BTC/USDT
                </span>
                <span 
                    id="connection-status" 
                    data-connection-status 
                    title="Connecting..." 
                    style="font-size: 1.2em; margin: 0 8px; display: inline-block;">🟡</span>
                <span class="price-display" id="header-price">$45,000.00</span>
                <span class="price-change positive" id="header-change">
                    <i class="fas fa-arrow-up"></i> +2.5%
                </span>
            </div>
            <div class="text-end">
                <small class="text-muted d-block">Last Updated</small>
                <span id="header-timestamp">--:--:--</span>
            </div>
        </div>
        <!-- Settings Dropdown -->
        <div class="dropdown settings-dropdown">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-cog"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                <li><a class="dropdown-item" href="#"><i class="fas fa-chart-line"></i> Chart Settings</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-bell"></i> Notifications</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-palette"></i> Theme</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Back to Dashboard</a></li>
            </ul>
        </div>
    </div>

    <!-- New Grid Layout -->
    <div class="terminal-grid">
        <!-- Left Column: Bot Control Panel -->
        <div class="left-panel">
            <div class="panel">
                <h5 class="mb-3">
                    <span class="status-indicator active" id="bot-status-indicator"></span>
                    Bot Status
                </h5>
                <div class="info-row">
                    <span class="info-label">Strategy</span>
                    <span class="info-value">Grid Trading</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Next Action</span>
                    <span class="info-value" id="next-action">SELL at $46,000</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Target Price</span>
                    <span class="info-value" id="target-price">$46,000.00</span>
                </div>
                <button class="btn btn-bot-control w-100 mt-3" id="bot-toggle-btn" onclick="toggleBot()">
                    <i class="fas fa-pause"></i> Pause Bot
                </button>
            </div>

            <div class="panel">
                <h5><i class="fas fa-bolt"></i> Quick Trade</h5>
                <select class="amount-selector" id="quick-trade-amount">
                    <option value="0.001" id="quickTradeOption0">0.001 BTC (<span id="quickTradeEstimate0">~$45</span>)</option>
                    <option value="0.01" selected id="quickTradeOption1">0.01 BTC (<span id="quickTradeEstimate1">~$450</span>)</option>
                    <option value="0.1" id="quickTradeOption2">0.1 BTC (<span id="quickTradeEstimate2">~$4,500</span>)</option>
                </select>
                <div class="d-grid gap-2">
                    <button class="btn-trade-buy" onclick="quickBuy()">
                        <i class="fas fa-arrow-up"></i> BUY
                    </button>
                    <button class="btn-trade-sell" onclick="quickSell()">
                        <i class="fas fa-arrow-down"></i> SELL
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">Estimated: <span id="quick-trade-value">$450.00</span></small>
                </div>
            </div>

            <div class="panel">
                <h5><i class="fas fa-exchange-alt"></i> Manual Trading</h5>
                <div class="balance-display mb-3">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-value" id="available-usdt-balance">$950.00 USDT</div>
                </div>
                <label class="form-label text-muted">Amount (BTC)</label>
                <input type="number" class="amount-selector" id="manual-amount" 
                       placeholder="0.01" step="0.001" min="0.001" max="1.0" value="0.01">
                <div class="info-row">
                    <span class="info-label">Estimated Value</span>
                    <span class="info-value" id="manual-estimated-value">$450.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Trading Fee (0.1%)</span>
                    <span class="info-value" id="manual-fee">$0.45</span>
                </div>
                <div class="risk-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Max recommended trade: 0.5 BTC
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirm-risks">
                    <label class="form-check-label text-muted" for="confirm-risks">
                        I understand the risks
                    </label>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn-trade-buy" id="manual-buy-btn" disabled>
                        <i class="fas fa-arrow-up"></i> BUY
                    </button>
                    <button class="btn-trade-sell" id="manual-sell-btn" disabled>
                        <i class="fas fa-arrow-down"></i> SELL
                    </button>
                </div>
            </div>

            <div class="panel">
                <h5><i class="fas fa-robot"></i> AI Co-Pilot</h5>
                <label class="form-label text-muted">AI Mode</label>
                <select class="amount-selector" id="aiMode">
                    <option value="opinion">Opinion Only</option>
                    <option value="suggest">Suggest Trades</option>
                    <option value="copilot">Co-Pilot Mode</option>
                </select>
                <div class="ai-message-box" id="ai-message">
                    <small class="text-muted">AI initializing...</small>
                </div>
                <div>
                    <small class="text-muted">Confidence</small>
                    <div class="confidence-bar" style="display: none;">
                        <div class="confidence-fill" id="ai-confidence" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <input type="text" class="amount-selector" id="aiQuestion" 
                           placeholder="Ask AI a question..." style="margin-bottom: 10px;">
                    <button class="btn btn-outline-light btn-sm w-100" id="askAI">
                        <i class="fas fa-comments"></i> Ask AI
                    </button>
                </div>
            </div>
        </div>

        <!-- Center Column: Chart (70%) + Trade History (30%) -->
        <div class="center-panel">
            <div class="chart-section">
                <div class="timeframe-controls btn-group" role="group">
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="1m">1M</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="5m">5M</button>
                    <button type="button" class="btn btn-sm timeframe-btn active" data-timeframe="1h">1H</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="4h">4H</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="1d">1D</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="1w">1W</button>
                </div>
                <div class="chart-host">
                    <!-- IMPORTANT: preserve ID/classes for TradingChart -->
                    <div id="tradingChart" style="background: #0f172a; border-radius: 8px;"></div>
                </div>
            </div>
            <div class="history-section">
                <h6 class="mb-2"><i class="fas fa-history"></i> Order History</h6>
                <div class="table-responsive">
                    <table class="table table-dark order-history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="orderHistoryBody">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <em>Loading trade history...</em>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <a href="{% url 'trades' %}" class="btn btn-outline-light btn-sm w-100">
                    <i class="fas fa-list"></i> View All Orders
                </a>
            </div>
        </div>

        <!-- Right Column: Wallet, Position, Today's Results -->
        <div class="right-panel">
            <div class="panel">
                <h5><i class="fas fa-wallet"></i> Wallet Balance</h5>
                <div class="balance-display">
                    <div class="balance-label">Total Value</div>
                    <div class="balance-value" id="total-portfolio-value">$5,450.00</div>
                </div>
                <div class="info-row">
                    <span class="info-label">BTC</span>
                    <span class="info-value" id="portfolio-btc">0.100000</span>
                </div>
                <div class="info-row">
                    <span class="info-label">USDT</span>
                    <span class="info-value" id="portfolio-usdt">$950.00</span>
                </div>
                <div class="portfolio-chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <h5><i class="fas fa-chart-line"></i> Current Position</h5>
                <div id="pnlContainer">
                    <div class="info-row">
                        <span class="info-label">Entry Price</span>
                        <span class="info-value" id="entry-price">$44,000.00</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Current Price</span>
                        <span class="info-value" id="current-position-price">$45,000.00</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Unrealized P&L</span>
                        <span class="info-value pnl-positive" id="unrealized-pnl">+$100.00 (+2.27%)</span>
                    </div>
                    <div class="if-sold-now">
                        <div class="label">If Sold Now</div>
                        <div class="value" id="if-sold-value">$4,600.00</div>
                    </div>
                </div>
                <button class="btn btn-trade-sell w-100" onclick="quickSell()">
                    <i class="fas fa-hand-holding-usd"></i> Quick Sell Position
                </button>
            </div>

            <div class="panel">
                <h5><i class="fas fa-chart-pie"></i> Today's Results</h5>
                <div class="text-muted">Coming soon...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize portfolio pie chart
const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
const portfolioChart = new Chart(portfolioCtx, {
    type: 'doughnut',
    data: {
        labels: ['BTC', 'USDT'],
        datasets: [{
            data: [4500, 950],
            backgroundColor: ['#f7931a', '#26a17b'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Global trading chart instance
let tradingChart = null;

// Trading Functions
function quickBuy() {
    const amount = document.getElementById('quick-trade-amount').value;
    if (confirm(`Confirm BUY ${amount} BTC?`)) {
        console.log('Quick BUY:', amount);
        showNotification('Trade Executed', `BUY ${amount} BTC`, 'success');
    }
}

function quickSell() {
    if (confirm('Confirm SELL entire position?')) {
        console.log('Quick SELL position');
        showNotification('Trade Executed', 'SELL position', 'info');
    }
}

function manualBuy() {
    const amount = document.getElementById('manual-amount').value;
    if (confirm(`Confirm MANUAL BUY ${amount} BTC?`)) {
        console.log('Manual BUY:', amount);
        showNotification('Trade Executed', `BUY ${amount} BTC`, 'success');
    }
}

function manualSell() {
    const amount = document.getElementById('manual-amount').value;
    if (confirm(`Confirm MANUAL SELL ${amount} BTC?`)) {
        console.log('Manual SELL:', amount);
        showNotification('Trade Executed', `SELL ${amount} BTC`, 'info');
    }
}

function marketSell() {
    if (confirm('Confirm MARKET SELL and take profit?')) {
        console.log('Market SELL');
        showNotification('Trade Executed', 'Market SELL executed', 'success');
    }
}

function holdPosition() {
    console.log('Holding position');
    showNotification('Position Held', 'Continuing to hold position', 'info');
}

function toggleBot() {
    const indicator = document.getElementById('bot-status-indicator');
    const button = document.getElementById('bot-toggle-btn');
    
    if (indicator.classList.contains('active')) {
        indicator.classList.remove('active');
        indicator.classList.add('inactive');
        button.innerHTML = '<i class="fas fa-play"></i> Resume Bot';
        showNotification('Bot Paused', 'Trading bot has been paused', 'warning');
    } else {
        indicator.classList.remove('inactive');
        indicator.classList.add('active');
        button.innerHTML = '<i class="fas fa-pause"></i> Pause Bot';
        showNotification('Bot Resumed', 'Trading bot is now active', 'success');
    }
}

function setTimeframe(timeframe) {
    // Remove active class from all buttons
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Update chart with new timeframe
    if (tradingChart) {
        tradingChart.setTimeframe(timeframe);
        console.log('Timeframe changed to:', timeframe);
    }
}

// askAI() now handled by AICoPilot instance

// Enable/disable manual trading buttons based on risk confirmation
document.getElementById('confirm-risks').addEventListener('change', function() {
    const buyBtn = document.getElementById('manual-buy-btn');
    const sellBtn = document.getElementById('manual-sell-btn');
    buyBtn.disabled = !this.checked;
    sellBtn.disabled = !this.checked;
});

// ManualTrading handles estimated value/fee updates

// Update header timestamp
function updateTimestamp() {
    const now = new Date();
    document.getElementById('header-timestamp').textContent = now.toLocaleTimeString();
}
setInterval(updateTimestamp, 1000);
updateTimestamp();
</script>
{% endblock %}

{% block extra_js %}
<!-- Trading Terminal Component Libraries -->
<script src="{% static 'js/trading-chart.js' %}"></script>
<script src="{% static 'js/pnl-calculator.js' %}"></script>
<script src="{% static 'js/manual-trading.js' %}"></script>
<script src="{% static 'js/ai-copilot.js' %}"></script>

<!-- Terminal Initialization Orchestrator -->
<script src="{% static 'js/terminal-init.js' %}"></script>

<!-- Note: terminal-init.js automatically initializes all components on DOMContentLoaded -->
<!-- Access components via: TerminalInit.chart, TerminalInit.pnlCalc, etc. -->
{% endblock %}
