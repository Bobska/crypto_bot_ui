{% extends "base.html" %}
{% load static %}

<!--
    Working features to PRESERVE (do not alter logic; layout/styling changes only):
    - WebSocket connection and keepalive (terminal-init.js / websocket.js) with auto-reconnect and status indicator
    - TradingChart initialization and updates (trading-chart.js) including candlestick series and timeframes
    - Price update handlers (terminal-init.js): portfolio totals, quick-trade estimates, header price/change
    - Trade history display (terminal-init.js loadOrderHistory -> populates #orderHistoryBody)
    - Bot status indicators (emoji üü°/üü¢/üî¥ in template + status text/buttons)
    - Tooltip implementation on chart (trading-chart.js subscribeCrosshairMove using seriesPrices)
-->

<!--
    üìù IMPORTANT NOTES FOR COPILOT ‚Äî DO NOT BREAK THESE
    Keep all existing WebSocket connection code
    Keep all existing TradingChart initialization
    Keep all existing chart update logic
    Keep all existing tooltip code
    Keep all existing trade marker logic

    ONLY CHANGE:
    - HTML layout structure (3-column grid)
    - Card designs and styling
    - How data is displayed (not how it's received)
    - CSS styling and animations

    STRATEGY:
    - Move existing working code into new layout structure.
    - Don't rewrite working features ‚Äî just reorganize and restyle them.
-->

{% block title %}Trading Terminal - Crypto Bot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/trading-terminal.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Terminal Header -->
    <div class="terminal-header">
        <div class="header-left">
            <h2>ü§ñ CRYPTO BOT TERMINAL</h2>
            <span class="divider">|</span>
            <span class="symbol">BTC/USDT</span>
        </div>
        <div class="header-right">
            <span class="current-price" id="headerPrice">$0.00</span>
            <span class="connection-status" id="headerStatus">üü° CONNECTING</span>
            <!-- Legacy elements kept (hidden) for backward-compat with existing JS -->
            <span id="connection-status" data-connection-status title="Connecting..." style="display:none">üü°</span>
            <span id="header-price" style="display:none">$0.00</span>
            <span id="header-change" style="display:none"></span>
            <span id="header-timestamp" style="display:none"></span>
        </div>
    </div>

    <!-- New Grid Layout -->
    <div class="terminal-grid">
        <!-- Left Column: Bot Control Panel -->
        <div class="left-panel panel">
            <!-- Phase 3: New Bot Status Card -->
            <div class="bot-status-card">
                <div class="bot-status-header">
                    <span class="status-indicator" id="botStatusDot">‚óè</span>
                    <span id="botStatusText">BOT RUNNING</span>
                </div>
                
                <div class="bot-info">
                    <div class="info-row">
                        <span class="label">Position:</span>
                        <span class="value" id="botPosition">USDT</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Entry:</span>
                        <span class="value" id="botEntry">--</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Target:</span>
                        <span class="value" id="botTarget">--</span>
                    </div>
                </div>
                
                <div class="next-action-box">
                    <div class="next-action-title">‚è≥ NEXT ACTION</div>
                    <div class="next-action-text" id="nextActionText">Waiting...</div>
                </div>
                
                <div class="bot-controls">
                    <button class="btn-stop" id="stopBotBtn" onclick="toggleBot()">‚è∏ STOP BOT</button>
                </div>
            </div>

            <!-- COMMENTED OUT: Quick Trade Panel
            <div class="panel">
                <h5><i class="fas fa-bolt"></i> Quick Trade</h5>
                <select class="amount-selector" id="quick-trade-amount">
                    <option value="0.001" id="quickTradeOption0">0.001 BTC (<span id="quickTradeEstimate0">~$45</span>)</option>
                    <option value="0.01" selected id="quickTradeOption1">0.01 BTC (<span id="quickTradeEstimate1">~$450</span>)</option>
                    <option value="0.1" id="quickTradeOption2">0.1 BTC (<span id="quickTradeEstimate2">~$4,500</span>)</option>
                </select>
                <div class="d-grid gap-2">
                    <button class="btn-trade-buy" onclick="quickBuy()">
                        <i class="fas fa-arrow-up"></i> BUY
                    </button>
                    <button class="btn-trade-sell" onclick="quickSell()">
                        <i class="fas fa-arrow-down"></i> SELL
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">Estimated: <span id="quick-trade-value">$450.00</span></small>
                </div>
            </div>
            -->

            <!-- COMMENTED OUT: Manual Trading Panel
            <div class="panel">
                <h5><i class="fas fa-exchange-alt"></i> Manual Trading</h5>
                <div class="balance-display mb-3">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-value" id="available-usdt-balance">$950.00 USDT</div>
                </div>
                <label class="form-label text-muted">Amount (BTC)</label>
                <input type="number" class="amount-selector" id="manual-amount" 
                       placeholder="0.01" step="0.001" min="0.001" max="1.0" value="0.01">
                <div class="info-row">
                    <span class="info-label">Estimated Value</span>
                    <span class="info-value" id="manual-estimated-value">$450.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Trading Fee (0.1%)</span>
                    <span class="info-value" id="manual-fee">$0.45</span>
                </div>
                <div class="risk-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Max recommended trade: 0.5 BTC
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirm-risks">
                    <label class="form-check-label text-muted" for="confirm-risks">
                        I understand the risks
                    </label>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn-trade-buy" id="manual-buy-btn" disabled>
                        <i class="fas fa-arrow-up"></i> BUY
                    </button>
                    <button class="btn-trade-sell" id="manual-sell-btn" disabled>
                        <i class="fas fa-arrow-down"></i> SELL
                    </button>
                </div>
            </div>
            -->

            <!-- COMMENTED OUT: AI Co-Pilot Panel
            <div class="panel">
                <h5><i class="fas fa-robot"></i> AI Co-Pilot</h5>
                <label class="form-label text-muted">AI Mode</label>
                <select class="amount-selector" id="aiMode">
                    <option value="opinion">Opinion Only</option>
                    <option value="suggest">Suggest Trades</option>
                    <option value="copilot">Co-Pilot Mode</option>
                </select>
                <div class="ai-message-box" id="ai-message">
                    <small class="text-muted">AI initializing...</small>
                </div>
                <div>
                    <small class="text-muted">Confidence</small>
                    <div class="confidence-bar" style="display: none;">
                        <div class="confidence-fill" id="ai-confidence" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <input type="text" class="amount-selector" id="aiQuestion" 
                           placeholder="Ask AI a question..." style="margin-bottom: 10px;">
                    <button class="btn btn-outline-light btn-sm w-100" id="askAI">
                        <i class="fas fa-comments"></i> Ask AI
                    </button>
                </div>
            </div>
            -->
        </div><!-- END left-panel -->

        <!-- Center Column: Chart (70%) + Trade History (30%) -->
        <div class="center-panel panel">
            <div class="chart-section">
                <div class="timeframe-controls btn-group" role="group">
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="1m">1M</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="5m">5M</button>
                    <button type="button" class="btn btn-sm timeframe-btn active" data-timeframe="1h">1H</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="4h">4H</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="1d">1D</button>
                    <button type="button" class="btn btn-sm timeframe-btn" data-timeframe="1w">1W</button>
                </div>
                <div class="chart-host">
                    <!-- IMPORTANT: preserve ID/classes for TradingChart -->
                    <div id="tradingChart"></div>
                </div>
            </div>
            <!-- PHASE 5.2: Trade History Table -->
            <div class="trade-history-section">
                <h3 class="section-title">üìú RECENT TRADES</h3>
                <div class="trade-table">
                    <div class="trade-table-header">
                        <span class="col-time">Time</span>
                        <span class="col-action">Action</span>
                        <span class="col-price">Price</span>
                        <span class="col-amount">Amount</span>
                        <span class="col-profit">Profit</span>
                    </div>
                    <div class="trade-table-body" id="tradeTableBody">
                        <!-- Trades will be inserted here -->
                    </div>
                </div>
            </div>
        </div><!-- END center-panel -->

        <!-- Right Column: Wallet, Position, Today's Results -->
        <div class="right-panel panel">
            <!-- PHASE 4.1: Wallet Balance Card -->
            <div class="wallet-card">
                <h3 class="card-title">üí∞ WALLET BALANCE</h3>
                <div class="balance-row">
                    <span class="currency">USDT:</span>
                    <span class="amount" id="walletUSDT">$0.00</span>
                </div>
                <div class="balance-row">
                    <span class="currency">BTC:</span>
                    <span class="amount" id="walletBTC">0.000000</span>
                </div>
                <div class="total-value">
                    <div class="total-label">üìä TOTAL VALUE</div>
                    <div class="total-amount" id="totalValue">$0.00</div>
                    <div class="total-note">(if sold now)</div>
                </div>
            </div>

            <!-- PHASE 4.2: Current Position Card -->
            <div class="position-card">
                <h3 class="card-title">ü§ñ BOT POSITION</h3>
                <div class="position-status" id="positionStatus">Not Trading</div>
                <div class="position-details" id="positionDetails" style="display: none;">
                    <div class="detail-row">
                        <span class="label">Bought at:</span>
                        <span class="value" id="posEntryPrice">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Current:</span>
                        <span class="value" id="posCurrentPrice">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Profit:</span>
                        <span class="value profit-value" id="posProfit">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- PHASE 4.3: Today's Results Card -->
            <div class="results-card">
                <h3 class="card-title">üìÖ TODAY'S RESULTS</h3>
                <div class="result-row">
                    <span class="label">Trades:</span>
                    <span class="value" id="todayTrades">0</span>
                </div>
                <div class="result-row">
                    <span class="label">Total Profit:</span>
                    <span class="value profit-value" id="todayProfit">$0.00</span>
                </div>
            </div>
        </div><!-- END right-panel -->
    </div><!-- END terminal-grid -->
</div>

<script>
// Global trading chart instance
let tradingChart = null;

// Trading Functions
function quickBuy() {
    const amount = document.getElementById('quick-trade-amount').value;
    if (confirm(`Confirm BUY ${amount} BTC?`)) {
        console.log('Quick BUY:', amount);
        showNotification('Trade Executed', `BUY ${amount} BTC`, 'success');
    }
}

function quickSell() {
    if (confirm('Confirm SELL entire position?')) {
        console.log('Quick SELL position');
        showNotification('Trade Executed', 'SELL position', 'info');
    }
}

function manualBuy() {
    const amount = document.getElementById('manual-amount').value;
    if (confirm(`Confirm MANUAL BUY ${amount} BTC?`)) {
        console.log('Manual BUY:', amount);
        showNotification('Trade Executed', `BUY ${amount} BTC`, 'success');
    }
}

function manualSell() {
    const amount = document.getElementById('manual-amount').value;
    if (confirm(`Confirm MANUAL SELL ${amount} BTC?`)) {
        console.log('Manual SELL:', amount);
        showNotification('Trade Executed', `SELL ${amount} BTC`, 'info');
    }
}

function marketSell() {
    if (confirm('Confirm MARKET SELL and take profit?')) {
        console.log('Market SELL');
        showNotification('Trade Executed', 'Market SELL executed', 'success');
    }
}

function holdPosition() {
    console.log('Holding position');
    showNotification('Position Held', 'Continuing to hold position', 'info');
}

function toggleBot() {
    // Update new bot status card elements (Phase 3)
    const botStatusDot = document.getElementById('botStatusDot');
    const botStatusText = document.getElementById('botStatusText');
    const stopBotBtn = document.getElementById('stopBotBtn');
    
    // Check current state from dot
    const isActive = !botStatusDot.classList.contains('inactive');
    
    if (isActive) {
        // Stop the bot
        botStatusDot.classList.add('inactive');
        if (botStatusText) botStatusText.textContent = 'BOT STOPPED';
        if (stopBotBtn) stopBotBtn.innerHTML = '‚ñ∂ START BOT';
        showNotification('Bot Stopped', 'Trading bot has been stopped', 'warning');
    } else {
        // Start the bot
        botStatusDot.classList.remove('inactive');
        if (botStatusText) botStatusText.textContent = 'BOT RUNNING';
        if (stopBotBtn) stopBotBtn.innerHTML = '‚è∏ STOP BOT';
        showNotification('Bot Started', 'Trading bot is now active', 'success');
    }
    
    // Also update old elements if they exist (for backward compatibility)
    const indicator = document.getElementById('bot-status-indicator');
    const button = document.getElementById('bot-toggle-btn');
    if (indicator && button) {
        if (isActive) {
            indicator.classList.remove('active');
            indicator.classList.add('inactive');
            button.innerHTML = '<i class="fas fa-play"></i> Resume Bot';
        } else {
            indicator.classList.remove('inactive');
            indicator.classList.add('active');
            button.innerHTML = '<i class="fas fa-pause"></i> Pause Bot';
        }
    }
}

function setTimeframe(timeframe) {
    // Remove active class from all buttons
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Update chart with new timeframe
    if (tradingChart) {
        tradingChart.setTimeframe(timeframe);
        console.log('Timeframe changed to:', timeframe);
    }
}

// askAI() now handled by AICoPilot instance

// Enable/disable manual trading buttons based on risk confirmation
document.getElementById('confirm-risks').addEventListener('change', function() {
    const buyBtn = document.getElementById('manual-buy-btn');
    const sellBtn = document.getElementById('manual-sell-btn');
    buyBtn.disabled = !this.checked;
    sellBtn.disabled = !this.checked;
});

// ManualTrading handles estimated value/fee updates

// Update header timestamp
function updateTimestamp() {
    const now = new Date();
    document.getElementById('header-timestamp').textContent = now.toLocaleTimeString();
}
setInterval(updateTimestamp, 1000);
updateTimestamp();
</script>
{% endblock %}

{% block extra_js %}
<!-- Trading Terminal Component Libraries -->
<script src="{% static 'js/trading-chart.js' %}"></script>
<script src="{% static 'js/pnl-calculator.js' %}"></script>
<script src="{% static 'js/manual-trading.js' %}"></script>
<script src="{% static 'js/ai-copilot.js' %}"></script>

<!-- Terminal Initialization Orchestrator -->
<script src="{% static 'js/terminal-init.js' %}"></script>

<!-- Note: terminal-init.js automatically initializes all components on DOMContentLoaded -->
<!-- Access components via: TerminalInit.chart, TerminalInit.pnlCalc, etc. -->
{% endblock %}
